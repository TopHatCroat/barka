# Barka

My personal k3s cluster setup.

## Structure

* `./dev/` local development
* `./charts/` in-repo Helm charts
* `./tools/` cluster tools (non-Helm manifests)
* `./apps/` apps running in the cluster


## Local Development

1. Have [mise](https://mise.jdx.dev/dev-tools/) installed
2. `mise trust` to allow mise to use the `mise.toml`
3. `mise install`
4. Create `.env.local` (used by `mise -E local` tasks):

```dotenv
KUBECONFIG=dev/k3s/kubeconfig/kubeconfig.yaml
```

Tip: start from `.env.local.example`.

5. `mise -E local run local:up`

Production uses `mise.production.toml` and expects `KUBECONFIG` to be set in your shell.

Production (tools install via Helm; Infisical via Universal Auth):

```bash
export KUBECONFIG=~/kubeconfigs/production.yaml
export INFISICAL_CLIENT_ID=...
export INFISICAL_CLIENT_SECRET=...
mise -E production run prod:tools:apply
```

To sync application secrets in production, add `InfisicalSecret` CRDs under `tools/infisical/` (ignore the committed `tools/infisical/infisicalsecret.example.yaml`).

### Local k3s (Docker Desktop, single-node)

- Requirements: Docker Desktop running
- Compose file: `dev/k3s/docker-compose.yml`

Start the cluster:

```bash
mise -E local run local:up
```

Use kubectl (plain kubectl, kubeconfig generated by k3s):

```bash
export KUBECONFIG=dev/k3s/kubeconfig/kubeconfig.yaml
kubectl get nodes
```

Or via mise:

```bash
mise -E local run kube:kubectl -- get pods -A
```

Note: `local:up` installs tools by running `kube:tools:apply` (Helm-based) using the selected `KUBECONFIG`.

Endpoints:

- Kubernetes API: https://localhost:6443
- Ingress (Traefik): http://localhost:8080 and https://localhost:8443

Stop the cluster:

```bash
mise -E local run local:down
```

Reset (delete cluster data volume, regenerates certs, etc.):

```bash
mise -E local run local:reset
```

### Headlamp UI

Headlamp is installed by `mise -E local run local:up` from `charts/headlamp/`.

URL: http://headlamp.localhost:8080/

Production: Headlamp has no Ingress; use port-forward:

```bash
mise -E production run kube:headlamp:port-forward
```

Login token (creates a short-lived token):

```bash
mise -E local run kube:headlamp:token
```

To uninstall tools:

```bash
mise -E local run kube:tools:delete
```

### OpenClaw

The OpenClaw operator is installed by `kube:tools:apply`, and the instance is managed by the in-repo Helm chart at `charts/openclaw/` via `kube:apps:apply`.

Local secrets: set `OPENCLAW_GATEWAY_TOKEN` in `.env.local` (required). Provider keys are optional for boot (`ANTHROPIC_API_KEY` and/or `OPENAI_API_KEY`). Then run:

```bash
mise -E local run local:openclaw:secrets:apply
mise -E local run kube:apps:apply
```

Production secrets: sync to `secret/openclaw-api-keys` in the `openclaw` namespace via Infisical (must include `OPENCLAW_GATEWAY_TOKEN`). See `tools/infisical/openclaw-api-keys.example.yaml`.

Port-forward the instance service:

```bash
mise -E local run kube:openclaw:port-forward
```

Local Ingress:

- URL: http://openclaw.localhost:8080/
