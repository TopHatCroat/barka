# Barka

My personal k3s cluster setup.

## Structure

* `./dev/` local development
* `./tools/` tools used to manage the cluster
* `./apps/` apps running in the cluster


## Local Development

1. Have [mise](https://mise.jdx.dev/dev-tools/) installed
2. `mise trust` to allow mise to use the `mise.toml`
3. `mise install`
4. Create `.env.local` (used by `mise -E local` tasks):

```dotenv
KUBECONFIG=dev/k3s/kubeconfig/kubeconfig.yaml
```

5. `mise -E local run local:up`

### Local k3s (Docker Desktop, single-node)

- Requirements: Docker Desktop running
- Compose file: `dev/k3s/docker-compose.yml`

Start the cluster:

```bash
mise -E local run local:up
```

Use kubectl (plain kubectl, kubeconfig generated by k3s):

```bash
export KUBECONFIG=dev/k3s/kubeconfig/kubeconfig.yaml
kubectl get nodes
```

Or via mise:

```bash
mise -E local run k3s:kubectl -- get pods -A
```

Note: `local:up` installs everything in `tools/` by running `kubectl apply -f /tools` inside the k3s container.

Endpoints:

- Kubernetes API: https://localhost:6443
- Ingress (Traefik): http://localhost:8080 and https://localhost:8443

Stop the cluster:

```bash
mise -E local run local:down
```

Reset (delete cluster data volume, regenerates certs, etc.):

```bash
mise -E local run local:reset
```

### Headlamp UI

Headlamp is installed by `mise run local:up` from `tools/headlamp.yaml`.

URL: http://headlamp.localhost:8080/

Login token (dev-only, cluster-admin):

```bash
mise -E local run headlamp:token
```

Uninstall:

```bash
mise -E local run headlamp:uninstall
```
