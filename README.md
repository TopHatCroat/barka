# Barka

My personal k3s cluster setup.

## Structure

* `./dev/` local development
* `./charts/` in-repo Helm charts
* `./tools/` cluster tools (non-Helm manifests)
* `./apps/` apps running in the cluster

## Task Naming

- `kube:*`: cluster-agnostic operations using plain `kubectl`/`helm` against the selected mise environment (`KUBECONFIG`)
- `local:*`: local-only lifecycle tasks (k3s-in-Docker)
- `prod:*`: prod wrappers around `kube:*` tasks with guardrails (e.g. `confirm`)

Within `kube:*`:

- `kube:operators:*`: install/uninstall/diff cluster operators (Headlamp, OpenClaw operator, Infisical operator)
- `kube:secrets:*`: prod-only secret sync resources (InfisicalSecret)


## Local Development

1. Have [mise](https://mise.jdx.dev/dev-tools/) installed
2. `mise trust` to allow mise to use the `mise.toml`
3. `mise install`
4. Create `.env.local` (used by `mise -E local` tasks):

```dotenv
KUBECONFIG=dev/k3s/kubeconfig/kubeconfig.yaml
OPENCLAW_OWNER_PHONE=+15551234567
OPENCLAW_GATEWAY_TOKEN=REPLACE_ME
```

Tip: start from `.env.local.example`.

5. `mise -E local run local:up`

Prod uses `mise.prod.toml` (loads `.env.prod`). Set `KUBECONFIG` in `.env.prod` (recommended: point at a kubeconfig outside this repo, e.g. `~/kubeconfigs/barka.yaml`).

Prod (tools install via Helm; Infisical via Universal Auth):

- Put `KUBECONFIG`, `INFISICAL_CLIENT_ID`, and `INFISICAL_CLIENT_SECRET` in `.env.prod` (recommended) or export them in your shell.

```bash
mise -E prod run prod:tools:apply
```

Prod secrets are synced from Infisical by an `InfisicalSecret` resource rendered from `charts/openclaw/templates/infisical.yaml`.

### Local k3s (Docker Desktop, single-node)

- Requirements: Docker Desktop running
- Compose file: `dev/k3s/docker-compose.yml`

Start the cluster:

```bash
mise -E local run local:up
```

Use kubectl (plain kubectl, kubeconfig generated by k3s):

```bash
export KUBECONFIG=dev/k3s/kubeconfig/kubeconfig.yaml
kubectl get nodes
```

Or via mise:

```bash
mise -E local run kube:kubectl -- get pods -A
```

Note: `local:up` installs tools by running `kube:tools:apply` (Helm-based) using the selected `KUBECONFIG`.

Endpoints:

- Kubernetes API: https://localhost:6443
- Ingress (Traefik): http://localhost:8080 and https://localhost:8443

Stop the cluster:

```bash
mise -E local run local:down
```

Reset (delete cluster data volume, regenerates certs, etc.):

```bash
mise -E local run local:reset
```

### Headlamp UI

Headlamp is installed by `mise -E local run local:up` from `charts/headlamp/`.

URL: http://headlamp.localhost:8080/

Prod: Headlamp has no Ingress; use port-forward:

```bash
mise -E prod run kube:headlamp:port-forward
```

Login token (creates a short-lived token):

```bash
mise -E <env> run kube:headlamp:token
```

To uninstall tools:

```bash
mise -E <env> run kube:tools:delete
```

### OpenClaw

The OpenClaw operator is installed by `kube:tools:apply`, and the instance is managed by the in-repo Helm chart at `charts/openclaw/` via `kube:apps:apply`.

Local secrets: set `OPENCLAW_GATEWAY_TOKEN` in `.env.local` (required). `OPENCLAW_OWNER_PHONE` and `OPENAI_API_KEY` are optional. Then run:

Web search (optional): set `PERPLEXITY_API_KEY` (or `OPENROUTER_API_KEY`) in `.env.local`.

```bash
mise -E local run local:openclaw:secrets:apply
mise -E local run kube:apps:apply
```

Production secrets: Infisical syncs into `secret/openclaw-secrets` in the `openclaw` namespace (must include `OPENCLAW_GATEWAY_TOKEN`).

Port-forward the instance service:

```bash
mise -E local run kube:openclaw:port-forward
```

Local Ingress:

- URL: http://openclaw.localhost:8080/

Browser automation:

- Local enables the Chromium sidecar (see `charts/openclaw/values-local.yaml`).
