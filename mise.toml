[tools]
docker-cli = '29.2.0'
docker-compose = '5.0.2'
helm = '3.15.4'
kubectl = '1.29.1'

# -----------------------------------------------------------------------------
# Kube Tasks (env-agnostic)
# These operate on whatever cluster your selected mise environment points to.
# -----------------------------------------------------------------------------

[tasks."kube:wait-api"]
run = '''
#!/usr/bin/env sh
set -eu

tries=120
while [ "$tries" -gt 0 ]; do
  if kubectl --request-timeout=2s get --raw=/readyz >/dev/null 2>&1; then
    exit 0
  fi
  tries=$((tries - 1))
  sleep 1
done

echo "Timed out waiting for Kubernetes API" >&2
exit 1
'''

[tasks."kube:wait-nodes-ready"]
run = "kubectl wait --for=condition=Ready nodes --all --timeout=180s"

[tasks."kube:operators:apply"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|prod)}"

headlamp_values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  headlamp_values="-f charts/headlamp/values-local.yaml"
fi

# Headlamp
helm upgrade --install headlamp charts/headlamp \
  -n headlamp \
  --create-namespace \
  --wait \
  --timeout 5m \
  $headlamp_values

# OpenClaw Operator
helm upgrade --install openclaw-operator oci://ghcr.io/openclaw-rocks/charts/openclaw-operator \
  --version 0.9.13 \
  -n openclaw-operator-system \
  --create-namespace \
  --wait \
  --timeout 5m

# Infisical (production only)
if [ "$CLUSTER_ENV" = "prod" ]; then
  : "${INFISICAL_CLIENT_ID:?INFISICAL_CLIENT_ID must be set in your shell env}"
  : "${INFISICAL_CLIENT_SECRET:?INFISICAL_CLIENT_SECRET must be set in your shell env}"

  helm upgrade --install infisical-secrets-operator secrets-operator \
    --repo https://dl.cloudsmith.io/public/infisical/helm-charts/helm/charts/ \
    --version 0.10.11 \
    -n infisical-operator-system \
    --create-namespace \
    --wait \
    --timeout 5m

  kubectl -n infisical-operator-system create secret generic infisical-universal-auth-credentials \
    --from-literal=clientId="$INFISICAL_CLIENT_ID" \
    --from-literal=clientSecret="$INFISICAL_CLIENT_SECRET" \
    --dry-run=client \
    -o yaml | kubectl apply -f -
fi
'''

[tasks."kube:secrets:apply"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|prod)}"

if [ "$CLUSTER_ENV" != "prod" ]; then
  exit 0
fi

: "${PROJECT_NAME:?PROJECT_NAME must be set (Infisical project slug)}"

kubectl get ns openclaw >/dev/null 2>&1 || kubectl create ns openclaw

helm template openclaw charts/openclaw \
  -n openclaw \
  --set-string clusterEnv=prod \
  --set-string projectName="$PROJECT_NAME" \
  --set infisical.enabled=true \
  --set instance.enabled=false | kubectl apply -n openclaw -f -
'''

[tasks."kube:tools:apply"]
run = [
  { task = "kube:operators:apply" },
  { task = "kube:secrets:apply" },
]

[tasks."kube:secrets:delete"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|prod)}"

if [ "$CLUSTER_ENV" != "prod" ]; then
  exit 0
fi

: "${PROJECT_NAME:?PROJECT_NAME must be set (Infisical project slug)}"

if kubectl get ns openclaw >/dev/null 2>&1; then
  helm template openclaw charts/openclaw \
    -n openclaw \
    --set-string clusterEnv=prod \
    --set-string projectName="$PROJECT_NAME" \
    --set infisical.enabled=true \
    --set instance.enabled=false | kubectl delete -n openclaw -f - --ignore-not-found=true || true
fi
'''

[tasks."kube:operators:delete"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|prod)}"

if helm -n headlamp status headlamp >/dev/null 2>&1; then
  helm -n headlamp uninstall headlamp
fi

if helm -n openclaw-operator-system status openclaw-operator >/dev/null 2>&1; then
  helm -n openclaw-operator-system uninstall openclaw-operator
fi

if [ "$CLUSTER_ENV" = "prod" ]; then
  if helm -n infisical-operator-system status infisical-secrets-operator >/dev/null 2>&1; then
    helm -n infisical-operator-system uninstall infisical-secrets-operator
  fi

  kubectl -n infisical-operator-system delete secret infisical-universal-auth-credentials --ignore-not-found=true
fi
'''

[tasks."kube:tools:delete"]
run = [
  { task = "kube:secrets:delete" },
  { task = "kube:operators:delete" },
]

[tasks."kube:operators:diff"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|prod)}"

headlamp_values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  headlamp_values="-f charts/headlamp/values-local.yaml"
fi

helm template headlamp charts/headlamp -n headlamp $headlamp_values | kubectl diff -f -

helm template openclaw-operator oci://ghcr.io/openclaw-rocks/charts/openclaw-operator \
  --version 0.9.13 \
  -n openclaw-operator-system \
  --include-crds | kubectl diff -n openclaw-operator-system -f -

if [ "$CLUSTER_ENV" = "prod" ]; then
  helm template infisical-secrets-operator secrets-operator \
    --repo https://dl.cloudsmith.io/public/infisical/helm-charts/helm/charts/ \
    --version 0.10.11 \
    -n infisical-operator-system | kubectl diff -n infisical-operator-system -f -
fi
'''

[tasks."kube:secrets:diff"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|prod)}"

if [ "$CLUSTER_ENV" != "prod" ]; then
  exit 0
fi

: "${PROJECT_NAME:?PROJECT_NAME must be set (Infisical project slug)}"

helm template openclaw charts/openclaw \
  -n openclaw \
  --set-string clusterEnv=prod \
  --set-string projectName="$PROJECT_NAME" \
  --set infisical.enabled=true \
  --set instance.enabled=false | kubectl diff -n openclaw -f - || true
'''

[tasks."kube:tools:diff"]
run = [
  { task = "kube:operators:diff" },
  { task = "kube:secrets:diff" },
]

[tasks."kube:kubectl"]
run = "kubectl"

[tasks."kube:headlamp:token"]
run = '''
#!/usr/bin/env sh
set -eu

token="$(kubectl -n headlamp create token headlamp-admin)"

if command -v pbcopy >/dev/null 2>&1; then
  printf "%s" "$token" | pbcopy
  echo "Token copied to clipboard."
else
  echo "$token"
  echo "pbcopy not found; token printed only." >&2
fi
'''

[tasks."kube:headlamp:port-forward"]
run = "kubectl -n headlamp port-forward svc/headlamp 8081:80"

[tasks."kube:apps:apply"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|prod)}"

values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  values="-f charts/openclaw/values-local.yaml"
fi

helm upgrade --install openclaw charts/openclaw \
  -n openclaw \
  --create-namespace \
  --wait \
  --timeout 5m \
  --set-string clusterEnv="$CLUSTER_ENV" \
  --set-string projectName="${PROJECT_NAME-}" \
  --set infisical.enabled=false \
  --set instance.enabled=true \
  $values
'''

[tasks."kube:apps:delete"]
run = '''
#!/usr/bin/env sh
set -eu

if helm -n openclaw status openclaw >/dev/null 2>&1; then
  helm -n openclaw uninstall openclaw
fi
'''

[tasks."kube:apps:diff"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|prod)}"

values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  values="-f charts/openclaw/values-local.yaml"
fi

helm template openclaw charts/openclaw \
  -n openclaw \
  --set-string clusterEnv="$CLUSTER_ENV" \
  --set-string projectName="${PROJECT_NAME-}" \
  --set infisical.enabled=false \
  --set instance.enabled=true \
  $values | kubectl diff -n openclaw -f -
'''

[tasks."kube:openclaw:wait-secrets"]
run = '''
#!/usr/bin/env sh
set -eu

ns=openclaw
key=OPENCLAW_GATEWAY_TOKEN
secret=openclaw-secrets

tries=180
while [ "$tries" -gt 0 ]; do
  if kubectl -n "$ns" get secret "$secret" >/dev/null 2>&1; then
    val_b64="$(kubectl -n "$ns" get secret "$secret" -o jsonpath="{.data.$key}" 2>/dev/null || true)"
    if [ -n "${val_b64:-}" ]; then
      exit 0
    fi
  fi
  tries=$((tries - 1))
  sleep 1
done

echo "Timed out waiting for secret $ns/$secret to contain key $key" >&2
kubectl -n "$ns" get infisicalsecrets 2>/dev/null || true
kubectl -n "$ns" get secrets 2>/dev/null || true
exit 1
'''

[tasks."kube:openclaw:port-forward"]
run = "kubectl -n openclaw port-forward svc/openclaw 18789:18789 18793:18793"

# -----------------------------------------------------------------------------
# Local Tasks (local-only)
# These manage the local k3s-in-Docker lifecycle.
# -----------------------------------------------------------------------------

[tasks."local:k3s:up"]
run = "docker compose -f dev/k3s/docker-compose.yml up -d"
hide = true

[tasks."local:k3s:down"]
run = "docker compose -f dev/k3s/docker-compose.yml down"
hide = true

[tasks."local:k3s:reset"]
run = "docker compose -f dev/k3s/docker-compose.yml down -v && rm -f dev/k3s/kubeconfig/kubeconfig.yaml"
hide = true

[tasks."local:up"]
run = [
  { task = "local:k3s:up" },
  { task = "kube:wait-api" },
  { task = "kube:wait-nodes-ready" },
  { task = "kube:tools:apply" },
  { task = "local:openclaw:secrets:apply" },
  { task = "kube:apps:apply" },
]

[tasks."local:openclaw:secrets:apply"]
run = '''
#!/usr/bin/env sh
set -eu

ns=openclaw
name=openclaw-secrets

kubectl get ns "$ns" >/dev/null 2>&1 || kubectl create ns "$ns"

: "${OPENCLAW_GATEWAY_TOKEN:?Set OPENCLAW_GATEWAY_TOKEN in .env.local}"

  args="--from-literal=OPENCLAW_GATEWAY_TOKEN=$OPENCLAW_GATEWAY_TOKEN"
  for var in OPENAI_API_KEY OPENCLAW_OWNER_PHONE PERPLEXITY_API_KEY OPENROUTER_API_KEY FIRECRAWL_API_KEY GH_TOKEN GITHUB_PAT_KEY CLAW_EMAIL; do
    eval "val=\${$var-}"
    if [ -n "${val:-}" ]; then
      args="$args --from-literal=$var=$val"
    fi
  done

  # Multiline secrets (SSH keys) must be passed via files.
  tmp_files=""
  for var in SSH_PRIVATE_KEY SSH_KNOWN_HOSTS; do
    eval "val=\${$var-}"
    if [ -n "${val:-}" ]; then
      f="$(mktemp)"
      tmp_files="$tmp_files $f"
      printf "%s\n" "$val" > "$f"
      args="$args --from-file=$var=$f"
    fi
  done

  kubectl -n "$ns" create secret generic "$name" $args \
    --dry-run=client \
    -o yaml | kubectl apply -f -

  if [ -n "${tmp_files:-}" ]; then
    rm -f $tmp_files
  fi

# If OpenClaw is already running, restart to pick up env changes.
if kubectl -n openclaw get statefulset openclaw >/dev/null 2>&1; then
  kubectl -n openclaw delete pod openclaw-0 --ignore-not-found=true
fi
'''

[tasks."local:down"]
run = [
  { task = "local:k3s:down" },
]

[tasks."local:reset"]
run = [
  { task = "local:k3s:reset" },
]

# -----------------------------------------------------------------------------
# Production Tasks (wrappers)
# These are just guarded entrypoints to kube:* tasks.
# -----------------------------------------------------------------------------

[tasks."prod:up"]
confirm = "Apply tools + apps to the CURRENT kube context?"
run = [
  { task = "kube:wait-api" },
  { task = "kube:wait-nodes-ready" },
  { task = "kube:tools:apply" },
  { task = "kube:openclaw:wait-secrets" },
  { task = "kube:apps:apply" },
]

[tasks."prod:tools:diff"]
run = [
  { task = "kube:tools:diff" },
]

[tasks."prod:tools:apply"]
confirm = "Apply tools/ to the CURRENT kube context?"
run = [
  { task = "kube:tools:apply" },
]

[tasks."prod:tools:delete"]
confirm = "Delete tools/ from the CURRENT kube context?"
run = [
  { task = "kube:tools:delete" },
]

[tasks."prod:apps:diff"]
run = [
  { task = "kube:apps:diff" },
]

[tasks."prod:apps:apply"]
confirm = "Apply apps/ to the CURRENT kube context?"
run = [
  { task = "kube:openclaw:wait-secrets" },
  { task = "kube:apps:apply" },
]

[tasks."prod:apps:delete"]
confirm = "Delete apps/ from the CURRENT kube context?"
run = [
  { task = "kube:apps:delete" },
]
