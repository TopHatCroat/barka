[tools]
docker-cli = '29.2.0'
docker-compose = '5.0.2'
helm = '3.15.4'
kubectl = '1.29.1'

# -----------------------------------------------------------------------------
# Kube Tasks (env-agnostic)
# These operate on whatever cluster your selected mise environment points to.
# -----------------------------------------------------------------------------

[tasks."kube:wait-api"]
run = '''
#!/usr/bin/env sh
set -eu

tries=120
while [ "$tries" -gt 0 ]; do
  if kubectl --request-timeout=2s get --raw=/readyz >/dev/null 2>&1; then
    exit 0
  fi
  tries=$((tries - 1))
  sleep 1
done

echo "Timed out waiting for Kubernetes API" >&2
exit 1
'''

[tasks."kube:wait-nodes-ready"]
run = "kubectl wait --for=condition=Ready node/k3s --timeout=180s"

[tasks."kube:tools:apply"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|production)}"

headlamp_values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  headlamp_values="-f charts/headlamp/values-local.yaml"
fi

# Headlamp
helm upgrade --install headlamp charts/headlamp \
  -n headlamp \
  --create-namespace \
  --wait \
  --timeout 5m \
  $headlamp_values

# OpenClaw Operator
helm upgrade --install openclaw-operator oci://ghcr.io/openclaw-rocks/charts/openclaw-operator \
  --version 0.6.0 \
  -n openclaw-operator-system \
  --create-namespace \
  --wait \
  --timeout 5m

# Infisical (production only)
if [ "$CLUSTER_ENV" = "production" ]; then
  : "${INFISICAL_CLIENT_ID:?INFISICAL_CLIENT_ID must be set in your shell env}"
  : "${INFISICAL_CLIENT_SECRET:?INFISICAL_CLIENT_SECRET must be set in your shell env}"

  helm upgrade --install infisical-secrets-operator secrets-operator \
    --repo https://dl.cloudsmith.io/public/infisical/helm-charts/helm/charts/ \
    --version 0.10.11 \
    -n infisical-operator-system \
    --create-namespace \
    --wait \
    --timeout 5m

  kubectl -n infisical-operator-system create secret generic infisical-universal-auth-credentials \
    --from-literal=clientId="$INFISICAL_CLIENT_ID" \
    --from-literal=clientSecret="$INFISICAL_CLIENT_SECRET" \
    --dry-run=client \
    -o yaml | kubectl apply -f -

  # Apply any InfisicalSecret CRDs (ignore *.example.yaml)
  if ls tools/infisical/*.yaml >/dev/null 2>&1; then
    for f in tools/infisical/*.yaml; do
      case "$f" in
        *.example.yaml) continue ;;
      esac
      kubectl apply -f "$f"
    done
  fi
fi
'''

[tasks."kube:tools:delete"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|production)}"

if helm -n headlamp status headlamp >/dev/null 2>&1; then
  helm -n headlamp uninstall headlamp
fi

if helm -n openclaw-operator-system status openclaw-operator >/dev/null 2>&1; then
  helm -n openclaw-operator-system uninstall openclaw-operator
fi

if [ "$CLUSTER_ENV" = "production" ]; then
  # Delete InfisicalSecret CRDs first (ignore *.example.yaml)
  if ls tools/infisical/*.yaml >/dev/null 2>&1; then
    for f in tools/infisical/*.yaml; do
      case "$f" in
        *.example.yaml) continue ;;
      esac
      kubectl delete -f "$f" --ignore-not-found=true || true
    done
  fi

  if helm -n infisical-operator-system status infisical-secrets-operator >/dev/null 2>&1; then
    helm -n infisical-operator-system uninstall infisical-secrets-operator
  fi

  kubectl -n infisical-operator-system delete secret infisical-universal-auth-credentials --ignore-not-found=true
fi
'''

[tasks."kube:tools:diff"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|production)}"

headlamp_values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  headlamp_values="-f charts/headlamp/values-local.yaml"
fi

helm template headlamp charts/headlamp -n headlamp $headlamp_values | kubectl diff -f -

helm template openclaw-operator oci://ghcr.io/openclaw-rocks/charts/openclaw-operator \
  --version 0.6.0 \
  -n openclaw-operator-system \
  --include-crds | kubectl diff -n openclaw-operator-system -f -

if [ "$CLUSTER_ENV" = "production" ]; then
  helm template infisical-secrets-operator secrets-operator \
    --repo https://dl.cloudsmith.io/public/infisical/helm-charts/helm/charts/ \
    --version 0.10.11 \
    -n infisical-operator-system | kubectl diff -n infisical-operator-system -f -

  # Diff any InfisicalSecret CRDs (ignore *.example.yaml)
  if ls tools/infisical/*.yaml >/dev/null 2>&1; then
    for f in tools/infisical/*.yaml; do
      case "$f" in
        *.example.yaml) continue ;;
      esac
      kubectl diff -f "$f" || true
    done
  fi
fi
'''

[tasks."kube:kubectl"]
run = "kubectl"

[tasks."kube:headlamp:token"]
run = "kubectl -n headlamp create token headlamp-admin"

[tasks."kube:headlamp:port-forward"]
run = "kubectl -n headlamp port-forward svc/headlamp 8081:80"

[tasks."kube:apps:apply"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|production)}"

values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  values="-f charts/openclaw/values-local.yaml"
fi

owner_phone=""
owner_phone_b64="$(kubectl -n openclaw get secret openclaw-user -o jsonpath='{.data.OPENCLAW_OWNER_PHONE}' 2>/dev/null || true)"
if [ -n "${owner_phone_b64:-}" ]; then
  owner_phone="$(python3 -c 'import base64,sys; print(base64.b64decode(sys.argv[1]).decode("utf-8"))' "$owner_phone_b64" 2>/dev/null || true)"
fi
owner_phone_args=""
if [ -n "${owner_phone:-}" ]; then
  owner_phone_args="--set-string instance.ownerPhone=$owner_phone"
fi

# If an OpenClawInstance already exists (from before we Helm-managed it), adopt it.
if kubectl -n openclaw get openclawinstance openclaw >/dev/null 2>&1; then
  kubectl -n openclaw annotate openclawinstance openclaw \
    meta.helm.sh/release-name=openclaw \
    meta.helm.sh/release-namespace=openclaw \
    --overwrite
  kubectl -n openclaw label openclawinstance openclaw \
    app.kubernetes.io/managed-by=Helm \
    --overwrite
fi

helm upgrade --install openclaw charts/openclaw \
  -n openclaw \
  --create-namespace \
  --wait \
  --timeout 5m \
  $values \
  $owner_phone_args
'''

[tasks."kube:apps:delete"]
run = '''
#!/usr/bin/env sh
set -eu

if helm -n openclaw status openclaw >/dev/null 2>&1; then
  helm -n openclaw uninstall openclaw
fi
'''

[tasks."kube:apps:diff"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|production)}"

values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  values="-f charts/openclaw/values-local.yaml"
fi

owner_phone=""
owner_phone_b64="$(kubectl -n openclaw get secret openclaw-user -o jsonpath='{.data.OPENCLAW_OWNER_PHONE}' 2>/dev/null || true)"
if [ -n "${owner_phone_b64:-}" ]; then
  owner_phone="$(python3 -c 'import base64,sys; print(base64.b64decode(sys.argv[1]).decode("utf-8"))' "$owner_phone_b64" 2>/dev/null || true)"
fi
owner_phone_args=""
if [ -n "${owner_phone:-}" ]; then
  owner_phone_args="--set-string instance.ownerPhone=$owner_phone"
fi

helm template openclaw charts/openclaw \
  -n openclaw \
  $values \
  $owner_phone_args | kubectl diff -n openclaw -f -
'''

[tasks."kube:openclaw:port-forward"]
run = "kubectl -n openclaw port-forward svc/openclaw 18789:18789 18793:18793"

# -----------------------------------------------------------------------------
# Local Tasks (local-only)
# These manage the local k3s-in-Docker lifecycle.
# -----------------------------------------------------------------------------

[tasks."local:k3s:up"]
run = "docker compose -f dev/k3s/docker-compose.yml up -d"
hide = true

[tasks."local:k3s:down"]
run = "docker compose -f dev/k3s/docker-compose.yml down"
hide = true

[tasks."local:k3s:reset"]
run = "docker compose -f dev/k3s/docker-compose.yml down -v && rm -f dev/k3s/kubeconfig/kubeconfig.yaml"
hide = true

[tasks."local:up"]
run = [
  { task = "local:k3s:up" },
  { task = "kube:wait-api" },
  { task = "kube:wait-nodes-ready" },
  { task = "kube:tools:apply" },
  { task = "local:openclaw:user:apply" },
  { task = "local:openclaw:secrets:apply" },
  { task = "kube:apps:apply" },
]

[tasks."local:openclaw:user:apply"]
run = '''
#!/usr/bin/env sh
set -eu

if [ -z "${OPENCLAW_OWNER_PHONE-}" ]; then
  echo "OPENCLAW_OWNER_PHONE is not set; skipping openclaw-user secret" >&2
  exit 0
fi

kubectl get ns openclaw >/dev/null 2>&1 || kubectl create ns openclaw

kubectl -n openclaw create secret generic openclaw-user \
  --from-literal=OPENCLAW_OWNER_PHONE="$OPENCLAW_OWNER_PHONE" \
  --dry-run=client \
  -o yaml | kubectl apply -f -

# If OpenClaw is already running, restart to pick up envFrom changes.
if kubectl -n openclaw get statefulset openclaw >/dev/null 2>&1; then
  kubectl -n openclaw delete pod openclaw-0 --ignore-not-found=true
fi
'''

[tasks."local:openclaw:secrets:apply"]
run = '''
#!/usr/bin/env sh
set -eu

ns=openclaw
name=openclaw-api-keys

kubectl get ns "$ns" >/dev/null 2>&1 || kubectl create ns "$ns"

: "${OPENCLAW_GATEWAY_TOKEN:?Set OPENCLAW_GATEWAY_TOKEN in .env.local}"

args="--from-literal=OPENCLAW_GATEWAY_TOKEN=$OPENCLAW_GATEWAY_TOKEN"
for var in ANTHROPIC_API_KEY OPENAI_API_KEY; do
  eval "val=\${$var-}"
  if [ -n "${val:-}" ]; then
    args="$args --from-literal=$var=$val"
  fi
done

kubectl -n "$ns" create secret generic "$name" $args \
  --dry-run=client \
  -o yaml | kubectl apply -f -
'''

[tasks."local:down"]
run = [
  { task = "local:k3s:down" },
]

[tasks."local:reset"]
run = [
  { task = "local:k3s:reset" },
]

# -----------------------------------------------------------------------------
# Production Tasks (wrappers)
# These are just guarded entrypoints to kube:* tasks.
# -----------------------------------------------------------------------------

[tasks."prod:tools:diff"]
run = [
  { task = "kube:tools:diff" },
]

[tasks."prod:tools:apply"]
confirm = "Apply tools/ to the CURRENT kube context?"
run = [
  { task = "kube:tools:apply" },
]

[tasks."prod:tools:delete"]
confirm = "Delete tools/ from the CURRENT kube context?"
run = [
  { task = "kube:tools:delete" },
]

[tasks."prod:apps:diff"]
run = [
  { task = "kube:apps:diff" },
]

[tasks."prod:apps:apply"]
confirm = "Apply apps/ to the CURRENT kube context?"
run = [
  { task = "kube:apps:apply" },
]

[tasks."prod:apps:delete"]
confirm = "Delete apps/ from the CURRENT kube context?"
run = [
  { task = "kube:apps:delete" },
]
