[tools]
docker-cli = '29.2.0'
docker-compose = '5.0.2'
kubectl = '1.29.1'

# -----------------------------------------------------------------------------
# Kube Tasks (env-agnostic)
# These operate on whatever cluster your selected mise environment points to.
# -----------------------------------------------------------------------------

[tasks."kube:wait-api"]
run = '''
#!/usr/bin/env sh
set -eu

tries=120
while [ "$tries" -gt 0 ]; do
  if kubectl --request-timeout=2s get --raw=/readyz >/dev/null 2>&1; then
    exit 0
  fi
  tries=$((tries - 1))
  sleep 1
done

echo "Timed out waiting for Kubernetes API" >&2
exit 1
'''

[tasks."kube:wait-nodes-ready"]
run = "kubectl wait --for=condition=Ready nodes --all --timeout=180s"

[tasks."kube:tools:apply"]
run = "kubectl apply -f tools"

[tasks."kube:tools:delete"]
run = "kubectl delete -f tools --ignore-not-found=true"

[tasks."kube:tools:diff"]
run = "kubectl diff -f tools"

[tasks."kube:kubectl"]
run = "kubectl"

[tasks."kube:headlamp:token"]
run = "kubectl -n headlamp create token headlamp-admin"

# -----------------------------------------------------------------------------
# Local Tasks (local-only)
# These manage the local k3s-in-Docker lifecycle.
# -----------------------------------------------------------------------------

[tasks."local:k3s:up"]
run = "docker compose -f dev/k3s/docker-compose.yml up -d"
hide = true

[tasks."local:k3s:down"]
run = "docker compose -f dev/k3s/docker-compose.yml down"
hide = true

[tasks."local:k3s:reset"]
run = "docker compose -f dev/k3s/docker-compose.yml down -v && rm -f dev/k3s/kubeconfig/kubeconfig.yaml"
hide = true

[tasks."local:up"]
run = [
  { task = "local:k3s:up" },
  { task = "kube:wait-api" },
  { task = "kube:wait-nodes-ready" },
  { task = "kube:tools:apply" },
]

[tasks."local:down"]
run = [
  { task = "local:k3s:down" },
]

[tasks."local:reset"]
run = [
  { task = "local:k3s:reset" },
]

# -----------------------------------------------------------------------------
# Production Tasks (wrappers)
# These are just guarded entrypoints to kube:* tasks.
# -----------------------------------------------------------------------------

[tasks."prod:tools:diff"]
run = [
  { task = "kube:tools:diff" },
]

[tasks."prod:tools:apply"]
confirm = "Apply tools/ to the CURRENT kube context?"
run = [
  { task = "kube:tools:apply" },
]

[tasks."prod:tools:delete"]
confirm = "Delete tools/ from the CURRENT kube context?"
run = [
  { task = "kube:tools:delete" },
]
