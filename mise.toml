[tools]
docker-cli = '29.2.0'
docker-compose = '5.0.2'
helm = '3.15.4'
kubectl = '1.29.1'

# -----------------------------------------------------------------------------
# Kube Tasks (env-agnostic)
# These operate on whatever cluster your selected mise environment points to.
# -----------------------------------------------------------------------------

[tasks."kube:wait-api"]
run = '''
#!/usr/bin/env sh
set -eu

tries=120
while [ "$tries" -gt 0 ]; do
  if kubectl --request-timeout=2s get --raw=/readyz >/dev/null 2>&1; then
    exit 0
  fi
  tries=$((tries - 1))
  sleep 1
done

echo "Timed out waiting for Kubernetes API" >&2
exit 1
'''

[tasks."kube:wait-nodes-ready"]
run = "kubectl wait --for=condition=Ready node/k3s --timeout=180s"

[tasks."kube:tools:apply"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|production)}"

headlamp_values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  headlamp_values="-f charts/headlamp/values-local.yaml"
fi

# Headlamp
helm upgrade --install headlamp charts/headlamp \
  -n headlamp \
  --create-namespace \
  --wait \
  --timeout 5m \
  $headlamp_values

# Infisical (production only)
if [ "$CLUSTER_ENV" = "production" ]; then
  : "${INFISICAL_CLIENT_ID:?INFISICAL_CLIENT_ID must be set in your shell env}"
  : "${INFISICAL_CLIENT_SECRET:?INFISICAL_CLIENT_SECRET must be set in your shell env}"

  helm upgrade --install infisical-secrets-operator secrets-operator \
    --repo https://dl.cloudsmith.io/public/infisical/helm-charts/helm/charts/ \
    --version 0.10.11 \
    -n infisical-operator-system \
    --create-namespace \
    --wait \
    --timeout 5m

  kubectl -n infisical-operator-system create secret generic infisical-universal-auth-credentials \
    --from-literal=clientId="$INFISICAL_CLIENT_ID" \
    --from-literal=clientSecret="$INFISICAL_CLIENT_SECRET" \
    --dry-run=client \
    -o yaml | kubectl apply -f -
fi
'''

[tasks."kube:tools:delete"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|production)}"

if helm -n headlamp status headlamp >/dev/null 2>&1; then
  helm -n headlamp uninstall headlamp
fi

if [ "$CLUSTER_ENV" = "production" ]; then
  if helm -n infisical-operator-system status infisical-secrets-operator >/dev/null 2>&1; then
    helm -n infisical-operator-system uninstall infisical-secrets-operator
  fi

  kubectl -n infisical-operator-system delete secret infisical-universal-auth-credentials --ignore-not-found=true
fi
'''

[tasks."kube:tools:diff"]
run = '''
#!/usr/bin/env sh
set -eu

: "${CLUSTER_ENV:?CLUSTER_ENV must be set (local|production)}"

headlamp_values=""
if [ "$CLUSTER_ENV" = "local" ]; then
  headlamp_values="-f charts/headlamp/values-local.yaml"
fi

helm template headlamp charts/headlamp -n headlamp $headlamp_values | kubectl diff -f -

if [ "$CLUSTER_ENV" = "production" ]; then
  helm template infisical-secrets-operator secrets-operator \
    --repo https://dl.cloudsmith.io/public/infisical/helm-charts/helm/charts/ \
    --version 0.10.11 \
    -n infisical-operator-system | kubectl diff -f -
fi
'''

[tasks."kube:kubectl"]
run = "kubectl"

[tasks."kube:headlamp:token"]
run = "kubectl -n headlamp create token headlamp-admin"

[tasks."kube:headlamp:port-forward"]
run = "kubectl -n headlamp port-forward svc/headlamp 8081:80"

# -----------------------------------------------------------------------------
# Local Tasks (local-only)
# These manage the local k3s-in-Docker lifecycle.
# -----------------------------------------------------------------------------

[tasks."local:k3s:up"]
run = "docker compose -f dev/k3s/docker-compose.yml up -d"
hide = true

[tasks."local:k3s:down"]
run = "docker compose -f dev/k3s/docker-compose.yml down"
hide = true

[tasks."local:k3s:reset"]
run = "docker compose -f dev/k3s/docker-compose.yml down -v && rm -f dev/k3s/kubeconfig/kubeconfig.yaml"
hide = true

[tasks."local:up"]
run = [
  { task = "local:k3s:up" },
  { task = "kube:wait-api" },
  { task = "kube:wait-nodes-ready" },
  { task = "kube:tools:apply" },
]

[tasks."local:down"]
run = [
  { task = "local:k3s:down" },
]

[tasks."local:reset"]
run = [
  { task = "local:k3s:reset" },
]

# -----------------------------------------------------------------------------
# Production Tasks (wrappers)
# These are just guarded entrypoints to kube:* tasks.
# -----------------------------------------------------------------------------

[tasks."prod:tools:diff"]
run = [
  { task = "kube:tools:diff" },
]

[tasks."prod:tools:apply"]
confirm = "Apply tools/ to the CURRENT kube context?"
run = [
  { task = "kube:tools:apply" },
]

[tasks."prod:tools:delete"]
confirm = "Delete tools/ from the CURRENT kube context?"
run = [
  { task = "kube:tools:delete" },
]
