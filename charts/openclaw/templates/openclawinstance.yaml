apiVersion: openclaw.rocks/v1alpha1
kind: OpenClawInstance
metadata:
  name: {{ .Values.instance.name }}
  namespace: {{ .Release.Namespace }}
spec:
  config:
    raw:
{{- $cfg := deepCopy .Values.instance.configRaw -}}
{{- if .Values.instance.ownerPhone }}
{{- $channels := (get $cfg "channels") | default (dict) -}}
{{- $_ := set $cfg "channels" $channels -}}
{{- $wa := (get $channels "whatsapp") | default (dict) -}}
{{- $_ := set $channels "whatsapp" $wa -}}
{{- $_ := set $wa "allowFrom" (list .Values.instance.ownerPhone) -}}
{{- end }}
{{ toYaml $cfg | nindent 6 }}

  envFrom:
    - secretRef:
        name: {{ .Values.instance.envFromSecretName }}
    - secretRef:
        name: openclaw-user
        optional: true

  storage:
{{ toYaml .Values.instance.storage | nindent 4 }}

{{- if .Values.instance.chromium }}
  chromium:
{{ toYaml .Values.instance.chromium | nindent 4 }}
{{- end }}

  networking:
{{ toYaml .Values.instance.networking | nindent 4 }}

  security:
{{ toYaml .Values.instance.security | nindent 4 }}
